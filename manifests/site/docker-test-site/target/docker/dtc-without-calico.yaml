apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: DockerCluster
metadata:
    name: dtc
    namespace: default
---
apiVersion: cluster.x-k8s.io/v1alpha3
kind: Cluster
metadata:
    name: dtc
    namespace: default
spec:
    clusterNetwork:
        pods:
            cidrBlocks:
            - 172.17.0.0/16
        serviceDomain: cluster.local
        services:
            cidrBlocks:
            - 10.0.0.0/24
    controlPlaneRef:
        apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
        kind: KubeadmControlPlane
        name: dtc-control-plane
    infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
        kind: DockerCluster
        name: dtc
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: DockerMachineTemplate
metadata:
    name: dtc-control-plane-14072020
    namespace: default
spec:
    template:
        spec:
            extraMounts:
            -   containerPath: /var/run/docker.sock
                hostPath: /var/run/docker.sock
---
apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
kind: KubeadmControlPlane
metadata:
    name: dtc-control-plane
    namespace: default
spec:
    infrastructureTemplate:
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
        kind: DockerMachineTemplate
        name: dtc-control-plane-14072020
    kubeadmConfigSpec:
        clusterConfiguration:
            apiServer:
                certSANs:
                - localhost
                - 127.0.0.1
            controllerManager:
                extraArgs:
                    enable-hostpath-provisioner: 'true'
        initConfiguration:
            nodeRegistration:
                criSocket: /var/run/containerd/containerd.sock
                kubeletExtraArgs:
                    eviction-hard: nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%
        joinConfiguration:
            nodeRegistration:
                criSocket: /var/run/containerd/containerd.sock
                kubeletExtraArgs:
                    eviction-hard: nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%
    replicas: 3
    version: v1.17.0
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: DockerMachineTemplate
metadata:
    name: dtc-md-0
    namespace: default
spec:
    template:
        spec:
            extraMounts:
            -   containerPath: /var/run/docker.sock
                hostPath: /var/run/docker.sock
---
apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: KubeadmConfigTemplate
metadata:
    name: dtc-md-0
    namespace: default
spec:
    template:
        spec:
            joinConfiguration:
                nodeRegistration:
                    criSocket: /var/run/containerd/containerd.sock
                    kubeletExtraArgs:
                        eviction-hard: nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%
---
apiVersion: cluster.x-k8s.io/v1alpha3
kind: MachineDeployment
metadata:
    name: dtc-md-0
    namespace: default
spec:
    clusterName: dtc
    replicas: 3
    selector:
        matchLabels: null
    template:
        metadata:
            labels:
                nodepool: pool1
        spec:
            bootstrap:
                configRef:
                    apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
                    kind: KubeadmConfigTemplate
                    name: dtc-md-0
            clusterName: dtc
            infrastructureRef:
                apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
                kind: DockerMachineTemplate
                name: dtc-md-0
            version: v1.17.0
---
apiVersion: cluster.x-k8s.io/v1alpha3
kind: MachineHealthCheck
metadata:
    name: dtc-mhc-0
    namespace: default
spec:
    clusterName: dtc
    maxUnhealthy: 100%
    selector:
        matchLabels:
            nodepool: pool1
    unhealthyConditions:
    -   status: 'True'
        timeout: 30s
        type: E2ENodeUnhealthy
